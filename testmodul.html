<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidrapportering</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="testmodul.js"></script>
</head>
<body>
    <div class="container">
        <h1>Tidrapportering</h1>
        
        <!-- Kalendern för tidrapportering -->
        <div id="calendar-container">
            <button id="prev-month">&lt; Föregående</button>
            <h2 id="month-year"></h2>
            <button id="next-month">Nästa &gt;</button>
            <table id="calendar"></table>
        </div>
        
        <!-- Formulär för tidrapportering -->
        <form id="time-report-form" style="display: none;">
            <h3 id="selected-date"></h3>
            <label for="project-dropdown">Välj projekt:</label>
            <select id="project-dropdown" required>
                <option value="">Välj projekt</option>
            </select>

            <label for="time-type">Typ av tid:</label>
            <select id="time-type" required>
                <option value="Normal tid">Normal tid</option>
                <option value="Sjuk">Sjuk</option>
                <option value="Semester">Semester</option>
                <option value="VAB">VAB</option>
                <option value="Obetald tjänstledighet">Obetald tjänstledighet</option>
                <option value="Permission">Permission</option>
                <option value="Föräldraledighet">Föräldraledighet</option>
            </select>

            <label for="hours">Antal timmar:</label>
            <input type="number" id="hours" step="0.1" required>
            
            <label for="work-comment">Kommentar:</label>
            <textarea id="work-comment" name="work-comment" placeholder="Lägg till en kommentar (valfritt)"></textarea>

            <button type="submit">Rapportera tid</button>
        </form>

        <!-- Sektion för att visa totala timmar per projekt -->
        <div>
            <h3>Totala timmar per projekt</h3>
            <ul id="total-hours-container"></ul>
        </div>
        <button id="show-total-hours">Visa totala timmar per projekt</button>

        <button onclick="navigateTo('index.html')">Tillbaka</button>
    </div>

    <!-- JavaScript för att hantera tidrapportering -->
    <script type="module">
        import { db, collection, query, where, getDocs, addDoc, doc, getDoc, auth, onAuthStateChanged, updateDoc } from './firebase-config.js';

        document.addEventListener('DOMContentLoaded', () => {
            const calendar = document.getElementById('calendar');
            const timeReportForm = document.getElementById('time-report-form');
            const selectedDateHeader = document.getElementById('selected-date');
            const projectDropdown = document.getElementById('project-dropdown');
            const timeTypeDropdown = document.getElementById('time-type');
            const hoursInput = document.getElementById('hours');
            const commentInput = document.getElementById('work-comment');
            const monthYearHeader = document.getElementById('month-year');
            let selectedEmployeeName = null;
            let selectedDate = null;
            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth();
            let existingReportId = null;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.role === 'Elektriker') {
                            alert('Du har inte behörighet att rapportera tid.');
                            window.location.href = 'index.html';
                            return;
                        }

                        selectedEmployeeName = `${userData.firstName} ${userData.lastName}`;
                        generateCalendar(currentYear, currentMonth);
                        await loadProjects();
                        await markReportedDays(currentYear, currentMonth);
                    } else {
                        console.error('User document not found.');
                    }
                } else {
                    console.error('User not logged in');
                }
            });

            function generateCalendar(year, month) {
                const monthNames = ["Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti", "September", "Oktober", "November", "December"];
                const daysOfWeek = ["Må", "Ti", "On", "To", "Fr", "Lö", "Sö"];
                monthYearHeader.textContent = `${monthNames[month]} ${year}`;
                calendar.innerHTML = `<tr>${daysOfWeek.map(day => `<th>${day}</th>`).join('')}</tr>`;

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayIndex = (firstDayOfMonth + 6) % 7;

                let dayNumber = 1;
                let row = document.createElement('tr');

                for (let i = 0; i < 42; i++) {
                    const cell = document.createElement('td');

                    if (i >= firstDayIndex && dayNumber <= daysInMonth) {
                        cell.textContent = dayNumber;
                        cell.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;

                        cell.addEventListener('click', async () => {
                            selectedDate = cell.dataset.date;
                            const report = await getReportForDate(selectedDate);

                            if (report) {
                                existingReportId = report.id;
                                projectDropdown.value = report.projectId;
                                timeTypeDropdown.value = report.timeType;
                                hoursInput.value = report.hours;
                                commentInput.value = report.comment || '';
                                selectedDateHeader.textContent = `Ändra rapportering för ${selectedDate}`;
                            } else {
                                selectedDateHeader.textContent = `Rapportera tid för ${selectedDate}`;
                                timeReportForm.reset();
                                commentInput.value = '';
                                existingReportId = null;
                            }

                            timeReportForm.style.display = 'block';
                        });

                        dayNumber++;
                    } else {
                        cell.classList.add('empty-cell');
                    }

                    row.appendChild(cell);

                    if ((i + 1) % 7 === 0) {
                        calendar.appendChild(row);
                        row = document.createElement('tr');
                    }
                }
            }

            async function loadProjects() {
                try {
                    const q = query(collection(db, 'planning'), where('employees', 'array-contains', selectedEmployeeName));
                    const querySnapshot = await getDocs(q);

                    const employeeProjects = [];

                    for (const docSnapshot of querySnapshot.docs) {
                        const planningData = docSnapshot.data();
                        if (planningData.projectId) {
                            const projectDocRef = doc(db, 'projects', planningData.projectId);
                            const projectDoc = await getDoc(projectDocRef);

                            if (projectDoc.exists()) {
                                const projectData = projectDoc.data();
                                employeeProjects.push({ id: projectDoc.id, address: projectData.address });
                            }
                        }
                    }

                    if (employeeProjects.length > 0) {
                        projectDropdown.innerHTML = '<option value="">Välj projekt</option>';
                        employeeProjects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.id;
                            option.textContent = project.address || 'Ej specificerad';
                            projectDropdown.appendChild(option);
                        });
                    }

                } catch (error) {
                    console.error('Error fetching projects:', error);
                }
            }

            async function getReportForDate(date) {
                const q = query(
                    collection(db, 'timeReports'),
                    where('employee', '==', selectedEmployeeName),
                    where('date', '==', date)
                );

                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const reportDoc = querySnapshot.docs[0];
                    const reportData = reportDoc.data();

                    return {
                        id: reportDoc.id,
                        projectId: reportData.projectId,
                        timeType: reportData.timeType,
                        hours: reportData.hours,
                        comment: reportData.comment
                    };
                }

                return null;
            }

            async function getTotalHoursPerProject() {
                const projects = {};

                try {
                    const q = query(collection(db, 'timeReports'));
                    const querySnapshot = await getDocs(q);

                    querySnapshot.forEach(docSnapshot => {
                        const reportData = docSnapshot.data();
                        const projectId = reportData.projectId;
                        const hours = parseFloat(reportData.hours) || 0;

                        if (projects[projectId]) {
                            projects[projectId] += hours;
                        } else {
                            projects[projectId] = hours;
                        }
                    });

                    const totalHoursPerProject = Object.keys(projects).map(projectId => ({
                        projectId: projectId,
                        totalHours: projects[projectId]
                    }));

                    return totalHoursPerProject;

                } catch (error) {
                    console.error("Error calculating total hours per project:", error);
                }
            }

            async function displayTotalHoursPerProject() {
                const totalHoursPerProject = await getTotalHoursPerProject();
                const resultsContainer = document.getElementById('total-hours-container');
                resultsContainer.innerHTML = '';

                totalHoursPerProject.forEach(project => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Projekt ID: ${project.projectId} - Totala timmar: ${project.totalHours}`;
                    resultsContainer.appendChild(listItem);
                });
            }

            document.getElementById('show-total-hours').addEventListener('click', displayTotalHoursPerProject);
        });
    </script>
</body>
</html>
